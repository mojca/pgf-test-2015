% Copyright 2011 by Christophe Jorssen
%
% This file may be distributed and/or modified
%
% 1. under the LaTeX Project Public License and/or
% 2. under the GNU Public License.
%
% See the file doc/generic/pgf/licenses/LICENSE for more details.
\def\pgfmathode@stopadd{\pgfmathode@stopadd}

\def\pgfmathode@addindextofunc[#1]#2{%
  \begingroup
    \gdef\pgfmathode@func{}%
    \pgfmathode@addindextofunc@i[#1]#2\pgfmathode@stopadd}

\def\pgfmathode@addindextofunc@i[#1]#2#3{%
    \ifx#1#2
      \expandafter\gdef\expandafter\pgfmathode@func\expandafter{%
        \pgfmathode@func #2[\pgfmathode@index]}%
    \else
      \expandafter\gdef\expandafter\pgfmathode@func\expandafter{%
        \pgfmathode@func #2}%
    \fi
    \ifx#3\pgfmathode@stopadd
      \expandafter\gdef\expandafter\pgfmathode@func\expandafter{%
        \expandafter{\pgfmathode@func}}%
      \let\next\endgroup
    \else
      \def\next{\pgfmathode@addindextofunc@i[#1]#3}%
    \fi
    \next}

% Numerically solve a differential system with 1st order Runge-Kutta
% (Euler method) 
% dq1/dt = f1(t,q1,q2,...,qN)
% dq2/dt = f2(t,q1,q2,...,qN)
% ...
% dqN/dt = fN(t,q1,q2,...,qN)
% 
% #1: A pgf array where the solution will be stored.
% At the end:
% #1 -> {{t(0),q1(t(0)),q2(t(0)),...,qN(t(0))},
%        {t(1),q1(t(1)),q2(t(1)),...,qN(t(1))},
%        ...
%        {t(Nstep),q1(t(Nstep)),q2(t(Nstep)),...,qN(t(Nstep))}}
% #2: A pgf array with f1,f2,...,fN
% {f1}
% #3: A pgf array with initial conditions.
% {t(0),q1(t(0)),q2(t(0)),...,qN(t(0))}
% #4: t(Nstep)
% #5: Nstep (number of steps)
%
% * First order example: dq/dt = -q + 5 with IC=(t=0,q(0)=0)
% \pgfmathodeRKI{\Sol}{{-\Sol[1]+5}}{{0,0}}{3.5}{100}
% * Second order example: {dq1/dt=q2, dq2/dt=-q2/2-sin(q1)} (damped
%   pendulum) 
% \pgfmathodeRKI{\Sol}{{\Sol[2],-\Sol[2]/2-sin(deg(\Sol[1]))}}%
%   {{0,-1,5}}{15}{50}

\def\pgfmathodeRKI#1#2#3#4#5{%
  \begingroup
    \gdef#1{{#3}}%
    \expandafter\pgfmathode@addindextofunc\expandafter[%
      \expandafter#1\expandafter]\pgfutil@firstofone{#2}%
    \pgfmathparse{(#4-#1[0][0])/#5}%
    \edef\pgfmathode@Deltat{\pgfmathresult}%
    \pgfmathparse{dim(#3)-1}%
    \edef\pgfmathode@dimfunc{\pgfmathresult}%
    \pgfmathparse{#5-1}%
    \edef\pgfmathode@numstep{\pgfmathresult}%
    \foreach \pgfmathode@index in {0,...,\pgfmathode@numstep} {%
      \message{Step \pgfmathode@index...}%
      \foreach \pgfmathode@j in {1,...,\pgfmathode@dimfunc} {%
        \pgfmathparse{%
          \pgfmathode@Deltat*(\pgfmathode@func[\pgfmathode@j-1])+
          #1[\pgfmathode@index][\pgfmathode@j]}%
        \expandafter\xdef\csname
          pgfmathode@Sol@\romannumeral\pgfmathode@j\endcsname{%
            \pgfmathresult}%
      }
      \pgfmathparse{\pgfmathode@Deltat+#1[\pgfmathode@index][0]}%
      \xdef\pgfmathode@Sol@t{\pgfmathresult}%
      \xdef\pgfmathode@temp{}%
      \foreach \pgfmathode@j in {1,...,\pgfmathode@dimfunc} {%
        \ifx\pgfmathode@temp\pgfutil@empty
          \xdef\pgfmathode@temp{%
            \csname pgfmathode@Sol@\romannumeral\pgfmathode@j\endcsname}%
        \else
          \xdef\pgfmathode@temp{%
            \pgfmathode@temp,
            \csname pgfmathode@Sol@\romannumeral\pgfmathode@j\endcsname}%
        \fi}
      \xdef#1{%
        {\expandafter\pgfutil@firstofone#1,%
          {\pgfmathode@Sol@t,\pgfmathode@temp}}}%
    }
  \endgroup}

\endinput