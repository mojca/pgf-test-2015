\documentclass{article}

\makeatletter
\usepackage{pgf}
\usepgflibrary{luamath}

\begin{document}

X

\def\SHOW#1{%
	\dimen0=#1 %
	#1 = \the\dimen0
}

\SHOW{1pt}

\SHOW{1mm}

\SHOW{1cm}

\SHOW{1in}

\SHOW{1ex}

\SHOW{1em}

\SHOW{1bp}

\SHOW{1pc}

\SHOW{1dd}

\SHOW{1cc}

\SHOW{1sp}

%\tracingmacros=2 \tracingcommands=2
%
\newif\ifcomparewithtex
\pgfkeys{
	/ut/compare with TeX/.is if=comparewithtex,
	/ut/compare with TeX=true,
	/ut/.search also={/pgf/luamath},
	/pgf/luamath/show error message=true,
	/pgf/luamath/enable TeX fallback=false,
}

\newcount\numErrors
\def\parsertest{\pgfutil@ifnextchar[\parsertest@{\parsertest@[]}}%
\def\parsertest@[#1]#2#3#4{%
	\begingroup
	\pgfqkeys{/ut}{#1}%
	\pgfluamathparse{#2}%
	\let\actual=\pgfmathresult
	\ifcomparewithtex
		\ifpgfluamathusedTeXfallback
			\let\expectedTeX=\actual
		\else
			\pgfmathparse{#2}%
			\let\expectedTeX=\pgfmathresult
		\fi
	\else
		\def\expectedTeX{--}%
	\fi
	%
	\edef\expected{#3}%
	\def\success{1}%
	\ifx\expected\empty
		\ifx\actual\empty
		\else
			\def\success{0}%
		\fi
	\else
		\ifx\actual\expected
		\else
			\def\success{0}%
		\fi
	\fi
	%
	\if1\success
	\else
		\message{FAILURE for #2 expected \expected\space but was \actual^^J}%
		\global\advance\numErrors by1
	\fi
	%
	\if1\success
		\if1#4%
			\ifpgfmathunitsdeclared
			\else
				\def\success{0}%
			\fi
		\else
			\ifpgfmathunitsdeclared
				\def\success{0}%
			\fi
		\fi
		\if1\success
		\else
			\message{FAILURE for #2 expected units declared #4 but was \ifpgfmathunitsdeclared true\else false\fi^^J}%
			\global\advance\numErrors by1
		\fi
	\fi
	%
	\if1\success
		\ifcomparewithtex
			\dimen0=\actual pt %
			\dimen1=\expectedTeX pt %
			\advance\dimen0 by-\dimen1
			\ifdim\dimen0<0sp
				\dimen0=-\dimen0
			\fi
			\ifdim\dimen0 > 0.004pt %
				\def\success{0}%
				\message{FAILURE for #2 : matches expectations, but does NOT match TeX output (error \the\dimen0). expected \expectedTeX\space but was \actual^^J}%
				\global\advance\numErrors by1
			\fi
		\fi
	\fi
	%
	\message{#2 = \actual\space (pgf=\expectedTeX) \if1\success OK\else FAILURE\fi^^J}%
	\endgroup
}%

\parsertest{1}{1.000000}{0}
\parsertest{  1}{1.000000}{0}
\parsertest{-123}{-123.000000}{0}
\parsertest{+123}{123.000000}{0}
\parsertest{+1.23}{1.230000}{0}
\parsertest{+.123}{0.123000}{0}
\parsertest{1.23}{1.230000}{0}
\parsertest{1.}{1.000000}{0.000000}
\parsertest{0.123}{0.123000}{0}
\parsertest{.123}{0.123000}{0}
\parsertest{1e4}{10000.000000}{0}
\parsertest{1e-4}{0.000100}{0}
\parsertest{1e+4}{10000.000000}{0}
% only supported by FPU
\parsertest[compare with TeX=false]{1Y1.23e4]}{12300.000000}{0}
\parsertest{1.23e-004}{0.000123}{0}
\parsertest{004}{4.000000}{0}
\parsertest{1 + 10}{11.000000}{0}
\parsertest{1 - 10}{-9.000000}{0}
\parsertest{(1)}{1.000000}{0}
\parsertest{3 + 5*9 / (1+1) - 12}{13.500000}{0}
\parsertest{pi}{3.141593}{0}
\parsertest{sin(0)}{0.000000}{0}
\parsertest{sin(90)}{1.000000}{0}
\parsertest{cos(90)}{0.000000}{0}
\parsertest{pow(2,3)}{8.000000}{0}
\parsertest{-pow(2,3)}{-8.000000}{0}
\parsertest{-pi}{-3.141593}{0}
% this is actually UNSUPPORTED by TeX:
\parsertest[compare with TeX=false]{inf}{inf}{0}
\parsertest[compare with TeX=false]{INF}{inf}{0}
\parsertest{not(100)}{0.000000}{0}%  non-trivial since the function is pgfluamathfunctions.notPGF
\parsertest{2^2}{4.000000}{0}
% only supported by FPU
\parsertest[compare with TeX=false]{1Y2.0e0]^2}{4.000000}{0}
\parsertest{0-2^2}{-4.000000}{0}
\parsertest{-2^2}{-4.000000}{0}
\parsertest{pi^2}{9.869604}{0}
\parsertest{2^2+2}{6.000000}{0}
\parsertest{2^2-1}{3.000000}{0}
\parsertest{-1 + 4}{3.000000}{0}
\parsertest{2^2*5}{20.000000}{0}
\parsertest{2^(2+2)}{16.000000}{0}
\parsertest{multiply(2,3)^2}{36.000000}{0}
\parsertest{(2+3)^2}{25.000000}{0}
\parsertest{(2 + 3 ) ^ 2}{25.000000}{0}
\parsertest{2^add(1,1)}{4.000000}{0}
\parsertest{3!}{6.000000}{0}
\parsertest{1+3!}{7.000000}{0}
\parsertest{2*3!}{12.000000}{0}
\parsertest{3! + 1}{7.000000}{0}
\parsertest{3 !}{6.000000}{0}
\parsertest{3*2+4}{10.000000}{0}
\pgfmathdeclarefunction{x}{0}{\def\pgfmathresult{4}}%
\pgfmathdeclarefunction{N1}{3}{\pgfmathparse{#1+#2+#3}}%
\directlua{
function pgfluamathfunctions.x()
	return 4
end
function pgfluamathfunctions.N1(x,m,n)
	return x+m+n
end
}
\parsertest{2^x}{16.000000}{0}
\parsertest{exp(-x^2)}{0.000000}{0} % requires output format=fpu
\parsertest{N1(1,2,3)}{6.000000}{0}
\parsertest{ 1 + 2 * 4 ^ 2 }{33.000000}{0}
\parsertest{-x + 4}{0.000000}{0}
\parsertest{-x * 4}{-16.000000}{0}
\parsertest{-x * - 4}{16.000000}{0}
\parsertest{2*pi r}{360.000000}{0}
\parsertest{6.28318530717959 r}{360.000000}{0}
\parsertest{sin(2*pi r)}{-0.000000}{0}
\parsertest{1.5707963267949r + 1.5707963267949r}{180.000000}{0}
\parsertest{1 ? 42 : 0}{42.000000}{0}
\parsertest{-1 + 1 ? 42 : 0}{0.000000}{0}
\parsertest{1 + (1 ? 42 : 0)}{43.000000}{0}
\parsertest{1 ? 42 : 0 ? 5 : 6}{5.000000}{0}
\parsertest{(1 ? 42 : 0) ? 5 : 6}{5.000000}{0}
\parsertest{43 == 43}{1.000000}{0}
\parsertest{43 == 42}{0.000000}{0}
\parsertest{43 != 43}{0.000000}{0}
\parsertest{43 != 42}{1.000000}{0}
\parsertest{43 > 42}{1.000000}{0}
\parsertest{43 > 44}{0.000000}{0}
\parsertest{43 < 42}{0.000000}{0}
\parsertest{43 < 44}{1.000000}{0}
\parsertest{43 <= 44}{1.000000}{0}
\parsertest{43 >= 44}{0.000000}{0}
\parsertest{43 >= 44 == 1}{0.000000}{0}
\parsertest{!1}{0.000000}{0}
\parsertest{! 1}{0.000000}{0}
\parsertest{! -1}{0.000000}{0}
\parsertest{--1}{1.000000}{0}
\parsertest{! !1}{1.000000}{0}
\parsertest{3! - !0}{5.000000}{0}
\parsertest{1 && 1 }{1.000000}{0}
\parsertest{1 && 0 || 1 }{1.000000}{0}
\parsertest{1 && 0 && 1 }{0.000000}{0}
\parsertest{1 || 0 }{1.000000}{0}
\parsertest{0 || 0 || 1 }{1.000000}{0}


\parsertest{1pt}{1.000000}{1}
\parsertest{1mm}{2.845261}{1}
\parsertest{1cm}{28.452744}{1}
\parsertest{1in}{72.269989}{1}
% \parsertest{1ex}{4.305542}{1}
% \parsertest{1em}{10.000015}{1}
\parsertest{1bp}{1.003738}{1}
\parsertest{1dd}{1.070007}{1}
\parsertest{1cc}{12.840103}{1}
\parsertest{1sp}{0.000015}{1}
\parsertest{1pc}{12.000000}{1}
% these TeX macros must be defined and set, of course!



\count1=43
% this is actually UNSUPPORTED by TeX:
\parsertest[compare with TeX=false]{\count1}{43.000000}{0}
%
\newdimen\luamathparse@dimen
\luamathparse@dimen=42pt
\parsertest{1*\luamathparse@dimen}{42.000000}{1}
\parsertest{2\luamathparse@dimen}{84.000000}{1}
%
\newcount\luamathparse@count
\luamathparse@count=42
\parsertest{1*\luamathparse@count}{42.000000}{0}

% this is a BUG in TeX, but works in LUA...:
\parsertest[compare with TeX=false]{0.5\luamathparse@count}{21.000000}{0}
%
\setbox0=\hbox{1233}
\parsertest{\wd0}{20.000061}{1}
\parsertest{\ht0}{6.444443}{1}
\parsertest{\dp0}{0.000000}{1}

%--------------------------------------------------
% FIXME : these cases are still missing:
% if false then
% -- arrays created via '{}' and indexed with '[]'
% -- strings with "<str>"
% -- 'scalar' function
% -- hex/octal/binary input
% -- tex registers 
% -- What happens for undefined functions!? --> return nil and let TeX invoke its parser (no warning!?)
% -- width/height/depth
% end
%-------------------------------------------------- 


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% The following tests are just for the TeX part, not for the LUA part.
%
%

\parsertest[output format=float,compare with TeX=false]{4+4}{1Y8.0000000000e+00]}{0}

\begingroup
\pgfmathdeclarefunction{testfct}{0}{\def\pgfmathresult{42.42}}
\parsertest[parser,compare with TeX=false,show error message=false]{testfct}{}{0}
\parsertest[parser,enable TeX fallback]{testfct}{42.42}{0}
\endgroup

% Check that setseed is communicated to LUA:
\pgfmathsetseed{123}
\parsertest[compare with TeX=false]{rnd}{0.788318}{0}
\parsertest[compare with TeX=false]{rnd}{0.203068}{0}
\parsertest[compare with TeX=false]{rand}{-0.302874}{0}
\parsertest[compare with TeX=false]{rand}{-0.276781}{0}
\parsertest[compare with TeX=false]{random}{0.134639}{0}
\parsertest[compare with TeX=false]{random}{0.375968}{0}
\parsertest[compare with TeX=false]{random(4)}{2.000000}{0}
\parsertest[compare with TeX=false]{random(4)}{1.000000}{0}
\parsertest[compare with TeX=false]{random(4,10)}{10.000000}{0}
\parsertest[compare with TeX=false]{random(4,10)}{8.000000}{0}

\begingroup
% Check that 'trig format' is property communicated to LUA and
% implemented correctly:
\parsertest{sin(50)}{0.766044}{0}%
\parsertest{cos(50)}{0.642788}{0}%
\parsertest{tan(50)}{1.191754}{0}%
\parsertest{asin(0.766044)}{49.999961}{0}%
\parsertest{acos(0.642788)}{49.999971}{0}%
\parsertest{atan(1.191754)}{50.000010}{0}%
\parsertest{atan2(-4,3)}{-53.130102}{0}%
\parsertest{cot(50)}{0.839100}{0}%
\parsertest{sec(50)}{1.555724}{0}%
\parsertest{cosec(50)}{1.305407}{0}%
%
\pgfkeys{/pgf/trig format=rad}
\parsertest{sin(0.5)}{0.479426}{0}%
\parsertest{cos(0.5)}{0.877583}{0}%
\parsertest{tan(0.5)}{0.546302}{0}%
\parsertest{asin(0.5)}{0.523599}{0}%
\parsertest{acos(0.5)}{1.047198}{0}%
\parsertest{atan(0.5)}{0.463648}{0}%
\parsertest{atan2(-4,3)}{-0.927295}{0}%
\parsertest{cot(0.5)}{1.830488}{0}%
\parsertest{sec(0.5)}{1.139494}{0}%
\parsertest{cosec(0.5)}{2.085830}{0}%
\endgroup

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%5
% NO MORE TEST CASES HERE!

\ifnum\numErrors>0
	\PackageError{pgf}{Has \the\numErrors\space FAILURES}{}
\else
	\message{All cases PASSED^^J}%
\fi


\end{document}
