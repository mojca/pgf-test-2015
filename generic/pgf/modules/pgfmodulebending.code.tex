% Copyright 2013 by Till Tantau
%
% This file may be distributed and/or modified
%
% 1. under the LaTeX Project Public License and/or
% 2. under the GNU Public License.
%
% See the file doc/generic/pgf/licenses/LICENSE for more details.

\ProvidesFileRCS[v\pgfversion] $Header: /cvsroot/pgf/pgf/generic/pgf/modules/pgfmodulebending.code.tex,v 1.3 2013/08/30 11:44:10 tantau Exp $


%
% This file defines commands for drawing bending arrows and lines.
%

\usepgfmodule{nonlineartransformations}
\usepgflibrary{curvilinear}


% Configuration options for arrow tips:

\pgfkeys{
  /pgf/> mode/tangent/.code=\pgf@shorten@curved@endtrue\pgf@tip@bending@endfalse\pgf@tip@tanget@endtrue,
  /pgf/> mode/rigid/.code=\pgf@shorten@curved@endtrue\pgf@tip@bending@endfalse\pgf@tip@tanget@endfalse,
  /pgf/> mode/bent/.code=\pgf@shorten@curved@endtrue\pgf@tip@bending@endtrue,
  /pgf/> mode/bend/.style={/pgf/> mode=bent},
  /pgf/> mode/bending/.style={/pgf/> mode=bent},
  /pgf/< mode/tangent/.code=\pgf@shorten@curved@starttrue\pgf@tip@bending@startfalse\pgf@tip@tanget@starttrue,
  /pgf/< mode/rigid/.code=\pgf@shorten@curved@starttrue\pgf@tip@bending@startfalse\pgf@tip@tanget@startfalse,
  /pgf/< mode/bent/.code=\pgf@shorten@curved@starttrue\pgf@tip@bending@starttrue,
  /pgf/< mode/bend/.style={/pgf/> mode=bent},
  /pgf/< mode/bending/.style={/pgf/> mode=bent},
}

\newif\ifpgf@tip@bending@end
\newif\ifpgf@tip@tanget@end

\newif\ifpgf@tip@bending@start
\newif\ifpgf@tip@tanget@start




\def\pgf@handle@bending@end@arrow#1#2#3#4#5#6#7#8{%
  {%
    \pgftransformreset%
    \pgfsetcurvilinearbeziercurve{\pgfqpoint{#7}{#8}}{\pgfqpoint{#5}{#6}}{\pgfqpoint{#3}{#4}}{\pgfqpoint{#1}{#2}}%
    \pgftransformnonlinear{\pgfpointcurvilinearbezierorthogonal{\pgf@x}{\pgf@y}}
    \pgftransformscale{-1}%
    \pgf@x=0pt%
    \pgf@shorten@end%
    \advance\pgf@x by\pgf@shorten@end@additional%
    \pgftransformxshift{-\pgf@x}%
    \def\pgf@arrow@call##1{\csname pgf@arrow@code@##1\endcsname}%
    \pgf@endarrow%
  }%
}


\def\pgf@handle@bending@start@arrow#1#2#3#4#5#6#7#8{%
  {%
    \pgftransformreset%
    \pgfsetcurvilinearbeziercurve{\pgfqpoint{#1}{#2}}{\pgfqpoint{#3}{#4}}{\pgfqpoint{#5}{#6}}{\pgfqpoint{#7}{#8}}%
    \pgftransformnonlinear{\pgfpointcurvilinearbezierorthogonal{\pgf@x}{\pgf@y}}
    \pgftransformscale{-1}%
    \pgf@x=0pt%
    \pgf@shorten@start%
    \advance\pgf@x by\pgf@shorten@start@additional%
    \pgftransformxshift{-\pgf@x}%
    \def\pgf@arrow@call##1{\csname pgf@arrow@code@##1\endcsname}%
    \pgf@startarrow%
  }%
}



\def\pgf@do@shorten@end@curve@bending#1#2#3#4#5#6#7#8\pgf@stop{%
  \def\pgf@bending@pre@op{\noexpand#1}%
  \expandafter\def\expandafter\pgf@endarrowbending@info\expandafter{\pgf@endarrowbending@info{#3}{#4}{#6}{#7}}%
  \ifdim\pgf@x=0pt%
  \else%
    \expandafter\pgf@shorten@path@along@curve@end\pgf@endarrowbending@info%
  \fi%
}

\def\pgf@shorten@path@along@curve@end#1#2#3#4#5#6#7#8{%
  {%
    \pgftransformreset%
    \pgfsetcurvilinearbeziercurve{\pgfqpoint{#7}{#8}}{\pgfqpoint{#5}{#6}}{\pgfqpoint{#3}{#4}}{\pgfqpoint{#1}{#2}}%
    \pgf@x=0pt%
    \pgf@shorten@end%
    \advance\pgf@x by\pgf@shorten@end@additional%
    \pgf@process{\pgfcurvilineardistancetotime{\pgf@x}}%
  }%
  % Compute new curve:
  \pgfpointcurveattime{\pgf@x}{\pgfqpoint{#7}{#8}}{\pgfqpoint{#5}{#6}}{\pgfqpoint{#3}{#4}}{\pgfqpoint{#1}{#2}}%
  % \pgfx/y and \pgf xa/xb already correct. Need to setup remaining vector...
  \pgf@xb#3%
  \pgf@yb#4%
  \pgf@xb\pgf@time@t\pgf@xb%
  \pgf@yb\pgf@time@t\pgf@yb%
  \advance\pgf@xb by\pgf@time@s\pgf@xc%
  \advance\pgf@yb by\pgf@time@s\pgf@yc%
  \edef\pgfprocessresultsubpathsuffix{%
    \pgf@bending@pre@op{#1}{#2}%
    \noexpand\pgfsyssoftpath@curvetosupportatoken{\the\pgf@xb}{\the\pgf@yb}%
    \noexpand\pgfsyssoftpath@curvetosupportbtoken{\the\pgf@xa}{\the\pgf@ya}%
    \noexpand\pgfsyssoftpath@curvetotoken{\the\pgf@x}{\the\pgf@y}}%
  \edef\pgfpointsecondlastonpath{\noexpand\pgfqpoint{\the\pgf@xa}{\the\pgf@ya}}%
  \edef\pgfpointlastonpath{\noexpand\pgfqpoint{\the\pgf@x}{\the\pgf@y}}%
  \expandafter\expandafter\expandafter\def%
  \expandafter\expandafter\expandafter\pgfprocessresultpathsuffix%
  \expandafter\expandafter\expandafter{\expandafter\pgfprocessresultsubpathprefix\pgfprocessresultsubpathsuffix}%
}




\def\pgf@do@shorten@start@curve@bending#1#2#3#4#5#6#7#8#9{%
  \ifdim\pgf@x=0pt%
  \else%
    {%
      \pgftransformreset%
      \pgfsetcurvilinearbeziercurve{\pgfqpoint{#1}{#2}}{\pgfqpoint{#3}{#4}}{\pgfqpoint{#5}{#6}}{\pgfqpoint{#7}{#8}}%
      \pgf@x=0pt%
      \pgf@shorten@start%
      \advance\pgf@x by\pgf@shorten@start@additional%
      \pgf@process{\pgfcurvilineardistancetotime{\pgf@x}}%
    }%
    % Compute new curve:
    \pgfpointcurveattime{\pgf@x}{\pgfqpoint{#1}{#2}}{\pgfqpoint{#3}{#4}}{\pgfqpoint{#5}{#6}}{\pgfqpoint{#7}{#8}}%
    % \pgfx/y and \pgf xa/xb already correct. Need to setup remaining vector...
    \pgf@xb#5%
    \pgf@yb#6%
    \pgf@xb\pgf@time@t\pgf@xb%
    \pgf@yb\pgf@time@t\pgf@yb%
    \advance\pgf@xb by\pgf@time@s\pgf@xc%
    \advance\pgf@yb by\pgf@time@s\pgf@yc%
    \edef\pgfpointfirstonpath{\noexpand\pgfqpoint{\the\pgf@x}{\the\pgf@y}}%
    \edef\pgfpointsecondonpath{\noexpand\pgfqpoint{\the\pgf@xa}{\the\pgf@ya}}%
    \edef\pgfprocessresultpathsuffix{%
      \noexpand\pgfsyssoftpath@movetotoken{\the\pgf@x}{\the\pgf@y}%
      \noexpand\pgfsyssoftpath@curvetosupportatoken{\the\pgf@xa}{\the\pgf@ya}%
      \noexpand\pgfsyssoftpath@curvetosupportbtoken{\the\pgf@xb}{\the\pgf@yb}%
      \noexpand\pgfsyssoftpath@curvetotoken{#7}{#8}%
    }
    \expandafter\def\expandafter\pgfprocessresultpathsuffix\expandafter{\pgfprocessresultpathsuffix#9}
  \fi%  
}

\endinput
